<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>20:00 Test</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="sidebar">
        <!-- Buttons will be dynamically generated by JavaScript -->
    </div>

    <div class="main-content">
        <div class="timer" id="timer">
            Time remaining: <span id="time">20:00</span>
        </div>
        <div id="question-container">
            <!-- Questions will be loaded here -->
        </div>
        <button class="submit-test-button" onclick="submitTest()">Submit Test</button>
    </div>

    <script>
        // Timer countdown function
        var startTime; // Ensure this is declared globally
        var questionsData;
        var score = 0;
        var answeredQuestions = new Set(); // To track answered questions
        function startTimer(duration, display) {
            startTime = new Date(); // Set start time
            console.log("Timer started at: " + startTime); // Debug statement
            var timer = duration, minutes, seconds;
            setInterval(function () {
                var currentTime = new Date();
                var elapsedTime = Math.floor((currentTime - startTime) / 1000); // Seconds elapsed

                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    submitTest(); // Automatically submit test when time is up
                }
            }, 1000);
        }

        // Shuffle function to randomize the questions
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getRandomQuestions() {
            function getDifferentiationQuestions() {
                return [
                    {
                        generateQuestion: () => {
                            const x = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Differentiate: f(x) = ${x}x^2`,
                                answer: `${2 * x}x`,
                                score: 2
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const x = Math.floor(Math.random() * 10) + 1;
                            const a = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Differentiate: f(x) = ${x}x^3 + ${a}x`,
                                answer: `${3 * x}x^2 + ${a}`,
                                score: 3
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const x = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Differentiate: f(x) = e^${x}x`,
                                answer: `${x}e^${x}x`,
                                score: 4
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const x = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Differentiate: f(x) = sin(${x}x)`,
                                answer: `${x}cos(${x}x)`,
                                score: 3
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const x = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Differentiate: f(x) = ln(${x}x)`,
                                answer: `1/x`,
                                score: 4
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const x = Math.floor(Math.random() * 10) + 1;
                            const y = Math.floor(Math.random() * 10) + 1;
                            const z = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Differentiate: f(x) = ${x}x^5 - ${y}x^4 + ${z}x^3`,
                                answer: `${5 * x}x^4 - ${4 * y}x^3 + ${3 * z}x^2`,
                                score: 5
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const x = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Differentiate: f(x) = cos(${x}x)`,
                                answer: `-${x}sin(${x}x)`,
                                score: 5
                            };
                        }
                    }
                ];
            }

            function getIntegrationQuestions() {
                return [
                    {
                        generateQuestion: () => {
                            const x = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Integrate: ∫${x}x dx`,
                                answer: `${0.5 * x}x^2 + C`,
                                score: 2
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const a = Math.floor(Math.random() * 10) + 1;
                            const b = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Integrate: ∫(${a}x + ${b}) dx`,
                                answer: `${0.5 * a}x^2 + ${b}x + C`,
                                score: 3
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const x = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Integrate: ∫e^${x}x dx`,
                                answer: `(1/${x})e^(${x}x) + C`,
                                score: 4
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const x = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Integrate: ∫sin(${x}x) dx`,
                                answer: `-1/${x}cos(${x}x) + C`,
                                score: 3
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const x = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Integrate: ∫${x}x^3 dx`,
                                answer: `${x}/4x^4 + C`,
                                score: 5
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const x = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Integrate: ∫cos(${x}x) dx`,
                                answer: `1/${x}sin(${x}x) + C`,
                                score: 5
                            };
                        }
                    }
                ];
            }

            function getVectorsQuestions() {
                return [
                    {
                        generateQuestion: () => {
                            const a = Math.floor(Math.random() * 10) + 1;
                            const b = Math.floor(Math.random() * 10) + 1;
                            const c = Math.floor(Math.random() * 10) + 1;
                            const d = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Find the dot product of (${a},${b}) and (${c},${d})`,
                                answer: `${a * c + b * d}`,
                                score: 3
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const a = Math.floor(Math.random() * 10) + 1;
                            const b = Math.floor(Math.random() * 10) + 1;
                            const c = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Find the magnitude of the vector (${a},${b},${c})`,
                                answer: `${Math.sqrt(a*a + b*b + c*c).toFixed(2)}`,
                                score: 4
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const a = Math.floor(Math.random() * 10) + 1;
                            const b = Math.floor(Math.random() * 10) + 1;
                            const c = Math.floor(Math.random() * 10) + 1;
                            const d = Math.floor(Math.random() * 10) + 1;
                            const e = Math.floor(Math.random() * 10) + 1;
                            const f = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Find the cross product of (${a},${b},${c}) and (${d},${e},${f})`,
                                answer: `(${(b * f - c * e)}, ${(c * d - a * f)}, ${(a * e - b * d)})`,
                                score: 5
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const a = Math.floor(Math.random() * 10) + 1;
                            const b = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Find the angle between the vectors (${a},${b}) and (1,0) in radians`,
                                answer: `${Math.acos(a / Math.sqrt(a*a + b*b)).toFixed(2)}`,
                                score: 4
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const a = Math.floor(Math.random() * 10) + 1;
                            const b = Math.floor(Math.random() * 10) + 1;
                            const c = Math.floor(Math.random() * 10) + 1;
                            const scalar = Math.floor(Math.random() * 5) + 1;
                            return {
                                question: `Multiply the vector (${a},${b},${c}) by the scalar ${scalar}`,
                                answer: `(${a * scalar}, ${b * scalar}, ${c * scalar})`,
                                score: 3
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const a = Math.floor(Math.random() * 10) + 1;
                            const b = Math.floor(Math.random() * 10) + 1;
                            const c = Math.floor(Math.random() * 10) + 1;
                            const d = Math.floor(Math.random() * 10) + 1;
                            const e = Math.floor(Math.random() * 10) + 1;
                            const f = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Determine if the vectors (${a},${b},${c}) and (${d},${e},${f}) are parallel`,
                                answer: `${a/d === b/e && b/e === c/f ? "Yes" : "No"}`,
                                score: 5
                            };
                        }
                    },
                    {
                        generateQuestion: () => {
                            const a = Math.floor(Math.random() * 10) + 1;
                            const b = Math.floor(Math.random() * 10) + 1;
                            const c = Math.floor(Math.random() * 10) + 1;
                            const d = Math.floor(Math.random() * 10) + 1;
                            return {
                                question: `Find the projection of the vector (${a},${b}) onto (${c},${d})`,
                                answer: `(${((a * c + b * d) / (c * c + d * d)) * c}, ${((a * c + b * d) / (c * c + d * d)) * d})`,
                                score: 4
                            };
                        }
                    }
                ];
            }

            const differentiationQuestions = getDifferentiationQuestions();
            const integrationQuestions = getIntegrationQuestions();
            const vectorsQuestions = getVectorsQuestions();

            // Combine all questions into a single array
            const allQuestions = [
                ...differentiationQuestions,
                ...integrationQuestions,
                ...vectorsQuestions
            ];

            // Shuffle all questions and select a subset
            const selectedQuestions = shuffle(allQuestions).slice(0, 10).map(q => q.generateQuestion());

            // Adjust scores so total equals 10, while keeping the relative difficulty intact
            const totalScore = 10;
            const totalRawScore = selectedQuestions.reduce((sum, q) => sum + q.score, 0);
            selectedQuestions.forEach(q => q.score = (q.score / totalRawScore) * totalScore);

            return selectedQuestions;
        }


        window.onload = function () {
            var twentyMinutes = 60 * 20,
                display = document.querySelector('#time');
            startTimer(twentyMinutes, display);

            // Load random questions
            var questions = getRandomQuestions();
            var sidebar = document.querySelector('.sidebar');
            var questionContainer = document.getElementById('question-container');

            // Generate sidebar buttons
            questions.forEach((_, index) => {
                var button = document.createElement('button');
                button.textContent = `Q${index + 1}`;
                button.onclick = () => showQuestion(index + 1, questions);
                button.id = `button-${index + 1}`;
                sidebar.appendChild(button);
            });

            // Load the first question by default
            showQuestion(1, questions);
        };

        var questionsData;
        var score = 0;
        var answeredQuestions = new Set(); // To track answered questions

        function showQuestion(questionNumber, questions) {
            questionsData = questions;
            var questionContainer = document.getElementById('question-container');
            var question = questions[questionNumber - 1];
            questionContainer.innerHTML = `
                <div class="question">${question.question}</div>
                <div class="answer-area">
                    <label for="answer">Your Answer:</label>
                    <input type="text" id="answer" name="answer">
                    <button class="submit-button" onclick="submitAnswer(${questionNumber})">Submit Answer</button>
                </div>
                <div class="feedback" id="feedback-${questionNumber}"></div>
            `;

            // Disable the submit button if the question has already been answered
            if (answeredQuestions.has(questionNumber)) {
                document.querySelector('.submit-button').disabled = true;
            }
        }
        
        function normalizeAnswer(answer) {
            // Replace common math symbols with a standard format
            answer = answer.replace(/√/, 'sqrt').replace(/π/, 'pi');
            return answer.trim().toLowerCase();
        }

        function parseMathExpression(expression) {
            try {
                // Convert common math functions and constants to a standard format
                expression = expression.replace(/sqrt/g, 'Math.sqrt').replace(/pi/g, 'Math.PI');
                return new Function('return ' + expression)();
            } catch (e) {
                console.error('Error parsing math expression:', e);
                return NaN;
            }
        }

        function roundToSignificantFigures(num, sigFigs) {
            if (num === 0) return 0;
            const factor = Math.pow(10, sigFigs - Math.ceil(Math.log10(Math.abs(num))));
            return Math.round(num * factor) / factor;
        }

        function isAnswerCorrect(userAnswer, correctAnswer) {
            userAnswer = normalizeAnswer(userAnswer);
            correctAnswer = normalizeAnswer(correctAnswer);

            // Parse and evaluate the mathematical expressions
            var userValue = parseMathExpression(userAnswer);
            var correctValue = parseMathExpression(correctAnswer);

            // Check if the answers are numerically equivalent within two significant figures
            if (!isNaN(userValue) && !isNaN(correctValue)) {
                const roundedUserValue = roundToSignificantFigures(userValue, 2);
                const roundedCorrectValue = roundToSignificantFigures(correctValue, 2);
                return roundedUserValue === roundedCorrectValue;
            }

            // If not numeric, check for string inclusion (for algebraic or textual answers)
            return userAnswer.includes(correctAnswer);
        }

        function submitAnswer(questionNumber) {
            if (answeredQuestions.has(questionNumber)) {
                return; // Prevent resubmission
            }

            var answerInput = document.getElementById('answer');
            var answer = answerInput.value.trim();
            var correctAnswer = questionsData[questionNumber - 1].answer;
            var questionScore = questionsData[questionNumber - 1].score;

            var feedbackElement = document.getElementById('feedback-' + questionNumber);
            if (isAnswerCorrect(answer, correctAnswer)) {
                score += questionScore;
                feedbackElement.innerHTML = `<span class="feedback correct">Correct Answer!</span>`;

                // Mark the question as answered and disable its button
                var button = document.getElementById(`button-${questionNumber}`);
                button.classList.add('disabled');
                button.onclick = null; // Disable button click

                answeredQuestions.add(questionNumber); // Add to answered questions

                // Disable the submit button for this question
                var submitButton = document.querySelector('.submit-button');
                if (submitButton) {
                    submitButton.disabled = true;
                }
            } else {
                feedbackElement.innerHTML = `<span class="feedback incorrect">Incorrect Answer.</span>`;
            }
        }

        function submitTest() {
            var endTime = new Date(); // Track end time

            // Calculate time elapsed in seconds
            var timeElapsed = Math.floor((endTime - startTime) / 1000); // Seconds elapsed
            var timeLimit = 20 * 60; 
            var timeRemaining = Math.max(0, timeLimit - timeElapsed); // Time remaining

            // Calculate the score multiplier based on time remaining
            var multiplier = 1 + (timeRemaining / 100); // 1% increase per second remaining

            // Calculate the final score with multiplier
            var finalScore = score * multiplier;
            finalScore = Math.round(finalScore); // Round to nearest integer

            // Send the final score and test type to the server
            var testType = '20:00'; 
            window.location.href = `/test_finished?score=${finalScore}&testType=${testType}`;
        }
    </script>
</body>
</html>
